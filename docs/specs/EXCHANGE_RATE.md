# 환율 계산기 스펙

> **Phase**: `Phase 2`
> **한 줄 설명**: From 1개 + To 3개 통화를 동시에 환산하고, 수식 입력도 지원하는 환율 계산기

---

## 개요

사용자가 출발 통화(From) 1개와 도착 통화(To) 3개를 선택하고 금액을 입력하면 실시간으로 환산 결과를 표시한다.
수식 입력(`100 + 50 =`)이 가능하여 복잡한 금액 계산 후 환산도 지원한다.
환율 데이터는 Cloud Scheduler가 Firestore에 주기적으로 업데이트하며, 오프라인 환경에서는 캐시 → 목업 환율 순으로 fallback한다.

---

## 화면 구성

```
┌──────────────────────────────────┐
│  ← [아이콘] 환율 계산기          │  ← 앱바 (Hero 애니메이션)
├──────────────────────────────────┤
│                                  │
│  🇰🇷                     120     │  ← From 통화 행 (탭: 통화 선택)
│  KRW              ──────────────│  ← 활성 밑줄 (흰색)
│                                  │
│  🇺🇸          1 KRW = 0.0007 USD │  ← To 행 1 (힌트: 1단위 환율)
│  USD                  0.0840    │
│                  ──────────────  │  ← 비활성 밑줄 (흰색 38%)
│                                  │
│  🇪🇺          1 KRW = 0.0006 EUR │  ← To 행 2
│  EUR                  0.0773    │
│                  ──────────────  │
│                                  │
│  🇯🇵          1 KRW = 0.1034 JPY │  ← To 행 3
│  JPY                 12.41      │
│                  ──────────────  │
│                                  │
│ 2026.03.02. 오후 3:00 기준  🔄   │  ← 업데이트 시간 + 새로고침 버튼
├──────────────────────────────────┤
│  ⌫  │  AC  │  %  │  ÷          │
│  7  │   8  │  9  │  ×          │
│  4  │   5  │  6  │  -          │
│  1  │   2  │  3  │  +          │
│  0  │  00  │  .  │  =          │
└──────────────────────────────────┘
```

**테마**: 다크 그라디언트 (딥 네이비 → 틸)

---

## 기능 요구사항

### 통화 선택

- From / To 각각 원형 국기 + 통화 코드를 탭하면 통화 선택 Bottom Sheet가 열린다
- Bottom Sheet에서 통화 코드 또는 이름으로 검색할 수 있다
- 현재 선택된 통화는 체크 표시로 구분된다
- **From 변경**: 선택한 통화가 이미 To에 있으면 해당 To와 swap, 없으면 그대로 변경. 변경 후 입력값은 `0`으로 초기화
- **To 변경**: From 통화 및 다른 To 통화와 중복 선택 불가. 중복 시 토스트 표시 ("기준 통화로 사용 중입니다" / "이미 선택된 통화입니다")

### 금액 입력

- 키패드는 5×4 레이아웃
- 숫자(`0-9`, `00`), 연산자(`÷ × - +`), `%`, `.`, `⌫`, `AC/C`, `=`
- From 행만 편집 가능 (To 행은 항상 환산 결과 표시)
- **자릿수 제한**: 정수부 최대 12자리, 소수부 최대 8자리. 초과 시 토스트로 안내
- `00` 키: 선행 0 방지 (입력이 `0`이면 무시), 자릿수 제한에 따라 0을 1개 또는 2개 추가
- 입력값에는 천 단위 콤마가 자동 적용되어 표시

### 환산 계산

- 입력값이 변경될 때마다 즉시 3개 To 통화의 환산 결과를 계산하여 표시한다
- 수식이 완성되지 않은 경우(연산자로 끝나는 경우)에는 `0`을 표시한다
- `=`를 누르면 수식을 평가하고, 그 결과값을 기준으로 환산한다
- 환산 공식: `입력값 × (To환율 / From환율)` (모든 환율은 USD 기준)

### 1단위 환율 힌트

- 각 To 행의 금액 위에 힌트 텍스트로 `1 {FromCode} = {환산값} {ToCode}` 표시
- 예: `1 KRW = 0.0007 USD`

### 환율 데이터

- Cloud Scheduler가 매 정각 Open Exchange Rates API를 호출해 Firestore에 최신 환율 저장
- 앱은 Firestore에서 환율 데이터를 조회한다
- 로컬 캐시 유효 기간은 **1시간**이며, 만료 전에는 캐시를 사용하고 만료 후에는 Firestore에서 다시 조회
- **업데이트 시간**: 환율 데이터의 timestamp 기준으로 `yyyy.mm.dd. 오전/오후 h:mm 기준` 형식 표시

### 새로고침

- 업데이트 시간 우측의 새로고침 버튼 탭 시 Firestore에서 최신 환율 재조회
- 새로고침 중에는 iOS 스타일 스피너(`CupertinoActivityIndicator`)를 표시하며, 최소 **800ms** 동안 표시
- 캐시 우회 없음 (동일 데이터라면 캐시 유지)

### 목업 환율 Fallback

- Firestore 조회 실패 + 로컬 캐시 없음 시, 목업 환율(하드코딩 상수)을 사용한다
- Fallback 데이터는 USD 기준 24개 통화의 근사 환율 (`exchange_rate_fallback.dart`)
- Fallback 사용 시 `timestamp: 0`으로 식별하며:
  - 토스트: "임시 환율을 사용 중입니다"
  - 업데이트 시간: "임시 환율 사용 중"

### 지원 통화 (24개)

| 코드 | 이름 | 코드 | 이름 |
|------|------|------|------|
| KRW | 대한민국 원 | PHP | 필리핀 페소 |
| USD | 미국 달러 | INR | 인도 루피 |
| JPY | 일본 엔 | MXN | 멕시코 페소 |
| EUR | 유로 | BRL | 브라질 레알 |
| CNY | 중국 위안 | SEK | 스웨덴 크로나 |
| GBP | 영국 파운드 | NOK | 노르웨이 크로네 |
| AUD | 호주 달러 | NZD | 뉴질랜드 달러 |
| CAD | 캐나다 달러 | TRY | 터키 리라 |
| CHF | 스위스 프랑 | RUB | 러시아 루블 |
| HKD | 홍콩 달러 | ZAR | 남아공 랜드 |
| SGD | 싱가포르 달러 | TWD | 대만 달러 |
| THB | 태국 바트 | VND | 베트남 동 |

- Default: From = `KRW`, To = `['USD', 'EUR', 'JPY']`

---

## 금액 표시 규칙

| 조건 | 표시 형식 |
|------|-----------|
| 1,000 이상 | 소수점 없이 정수 표시 (예: `1,234,567`) |
| 1 이상 1,000 미만 | 소수점 2자리 (예: `123.45`) |
| 1 미만 | 소수점 4자리 (예: `0.0007`) |
| 0 | `0` |

---

## 예외 / 엣지 케이스

| 상황 | 기대 동작 |
|------|-----------|
| Firestore 조회 실패 | 만료된 로컬 캐시로 fallback |
| 캐시도 없는 최초 오프라인 실행 | 목업 환율 사용, "임시 환율을 사용 중입니다" 토스트 + "임시 환율 사용 중" 표시 |
| 수식 오류 (예: `0 ÷ 0`) | `오류` 표시, 환산 결과 `0` |
| 로딩 중 | 화면 전체 dim + 블러 오버레이 + "환율 정보를 가져오는 중..." 텍스트 |

---

## 비기능 요구사항

- **성능**: 입력값 변경 시 환산 결과 즉시 업데이트 (16ms 이내)
- **오프라인**: 캐시된 환율로 동작 가능, 캐시 없을 시 목업 환율 fallback
- **캐시 유효 기간**: 1시간
- **환율 소스**: Open Exchange Rates API → Cloud Scheduler → Firestore → 앱

---

## 수정 요청

> 개발 중 수정이 필요하다고 느낀 항목을 여기에 기록한다.
> 완료된 항목은 **상태**를 `수정완료`로 변경한다.

---

### from 통화 선택 — 날짜: 2026-03-02
**상태**: `수정완료`
1. from 통화 변경 시, 선택하려는 항목이 to 통화에 있는 경우, 선택 불가 토스트를 보여주는게 아니라, swap한다

---

### 새로 고침 버튼과 환율 정보 업데이트 시간 표시 — 날짜: 2026-03-02
**상태**: `수정완료`
1. 환율 정보를 새로 요청하는 새로고침 버튼
2. yyyy.mm.dd. 오전/오후 hh:mm
3. 통화 행과 키패드 구분선 사이에 배치 (좌: 업데이트 시간, 우: 새로고침 버튼)

---

### 1기준 통화 = to 통화 표시 — 날짜: 2026-03-02
**상태**: `수정완료`
1. 각각의 to 통화 금액 위에 hint 텍스트 처럼 표시
2. 현지 from 통화가 krw이이고 to 통화가 USD, EUR, JPY이면  각각의 to 통화 금액 위에 힌트 텍스트 처럼 '1KRW = ~~USD', '1KRW = ~~EUR' 형태로 표시

---

### CurrencyPickerSheet에서 이미 선택 된 항목을 선택 할 경우 — 날짜: 2026-03-02
**상태**: `수정완료`
1. 토스트로 알림
2. 이미 선택되어 있는 항목에 있으므로 선택되지 않음
---

### '한국 원' -> '대한민국 원' — 날짜: 2026-03-02
**상태**: `수정완료`

---

---

### 통화 표시는 금액 표시 형식으로 — 날짜: 2026-03-02
**상태**: `수정완료`
1. 예시) '1,000'

---

### 통화 선택 — 날짜: 2026-03-02
**상태**: `수정완료`
1. KRW의 가로 중앙에 국기가 중앙정렬 되어야함
2. 국기는 원형으로, 사이즈는 좀 더 크게
---

### 각각 통화 행간의 간격, 국기와 텍스트 정렬 — 날짜: 2026-03-02
**상태**: `수정완료`
1. 통화 행들 전체의 부모 컨테이너 height를 전부 사용하도록 간격을 조정
2. 통화 선택의 국기와 텍스트는 세로 가운데 정렬
---

### 스왑버튼 삭제, 기존 to 통화가 1개인데 3개로 수정 (default는 usd, eur, jpy) — 날짜: 2026-03-02
**상태**: `수정완료`

---

### 로딩 프로그레스를 로딩 + '환율 정보를 불러오고 있습니다'로 표시되도록 수정 — 날짜: 2026-03-02
**상태**: `수정완료`

---

### 통화의 폰트가 너무 큼, 조금 작게 수정 — 날짜: 2026-03-02
**상태**: `수정완료`

---

### 통화 선택에 국기도 함께 표시, 국기와 텍스트는 세로로 배치 — 날짜: 2026-03-02
**상태**: `수정완료`

---

### KRW 선택 창이 원화 표시 부분과 정렬이 맞아야 함. 기준은 원화 표시 영역 — 날짜: 2026-03-01
**상태**: `수정완료`

---

### 데이터 요청시 progress가 화면 중앙에 위치하지 않는 현상 수정 — 날짜: 2026-03-01
**상태**: `수정완료`

---

### 두 통화 표시 사이의 중앙에 위치한 아이콘을 좌측 usd, krw 사이에 위치하도록 수정 — 날짜: 2026-03-01
**상태**: `수정완료`

---

### default가 usd, krw가 아니고 krw, usd가 되도록 수정 — 날짜: 2026-03-01
**상태**: `수정완료`

---

## 참고 / 레퍼런스

- 구현 명세: `docs/dev/EXCHANGE_RATE_CALCULATOR.md`
- 환율 API Q&A: `docs/prompts/answers/` (Q0006 — 미답변)
